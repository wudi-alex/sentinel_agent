<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SentinelAgent - AI Agent系统分析与监控平台</title>
    
    <!-- Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- Element Plus -->
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <script src="https://unpkg.com/element-plus"></script>
    <script src="https://unpkg.com/@element-plus/icons-vue"></script>
    
    <!-- D3.js for visualization -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <!-- 自定义样式 -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
</head>
<body>
    <div id="app">
        <el-container class="main-container">
            <!-- 头部 -->
            <el-header class="header">
                <div class="header-content">
                    <h1 class="title">
                        🤖 SentinelAgent
                        <span class="subtitle">AI Agent系统分析与监控平台</span>
                    </h1>
                    <div class="header-actions">
                        <el-button type="primary" @click="showAbout = true">
                            关于
                        </el-button>
                    </div>
                </div>
            </el-header>

            <el-container>
                <!-- 侧边栏 -->
                <el-aside width="300px" class="sidebar">
                    <el-menu 
                        :default-active="activeTab" 
                        @select="handleMenuSelect"
                        class="sidebar-menu">
                        
                        <el-menu-item index="scanner">
                            <el-icon><Search /></el-icon>
                            <span>系统扫描</span>
                        </el-menu-item>
                        
                        <el-menu-item index="graph">
                            <el-icon><Connection /></el-icon>
                            <span>关系图构建</span>
                        </el-menu-item>
                        
                        <el-menu-item index="paths">
                            <el-icon><Guide /></el-icon>
                            <span>路径分析</span>
                        </el-menu-item>
                        
                        <el-menu-item index="logs">
                            <el-icon><Document /></el-icon>
                            <span>日志分析</span>
                        </el-menu-item>
                        
                        <el-menu-item index="results">
                            <el-icon><Folder /></el-icon>
                            <span>分析结果</span>
                        </el-menu-item>
                    </el-menu>

                    <!-- 示例项目 -->
                    <div class="examples-section">
                        <h3>示例项目</h3>
                        <el-card 
                            v-for="example in examples" 
                            :key="example.name"
                            class="example-card"
                            @click="loadExample(example)">
                            <div class="example-info">
                                <h4 v-text="example.name"></h4>
                                <p v-text="example.description"></p>
                                <el-tag :type="example.type === 'crewai' ? 'success' : 'warning'"
                                        v-text="example.type">
                                </el-tag>
                            </div>
                        </el-card>
                    </div>
                </el-aside>

                <!-- 主内容区 -->
                <el-main class="main-content">
                    <!-- 系统扫描 -->
                    <div v-show="activeTab === 'scanner'" class="tab-content">
                        <el-card class="content-card">
                            <template #header>
                                <h2>🔍 系统扫描</h2>
                            </template>
                            
                            <el-form :model="scanForm" label-width="120px">
                                <el-form-item label="扫描路径">
                                    <el-input 
                                        v-model="scanForm.path" 
                                        placeholder="请输入要扫描的目录或文件路径"
                                        class="path-input">
                                        <template #append>
                                            <el-button @click="selectPath">浏览</el-button>
                                        </template>
                                    </el-input>
                                </el-form-item>
                                
                                <el-form-item label="扫描类型">
                                    <el-radio-group v-model="scanForm.type">
                                        <el-radio label="directory">目录</el-radio>
                                        <el-radio label="file">单个文件</el-radio>
                                    </el-radio-group>
                                </el-form-item>
                                
                                <el-form-item>
                                    <el-button 
                                        type="primary" 
                                        @click="executeScan"
                                        :loading="scanLoading">
                                        开始扫描
                                    </el-button>
                                    <el-button @click="clearScanResult">清空结果</el-button>
                                    <el-button type="info" @click="loadDemoData">加载演示数据</el-button>
                                </el-form-item>
                            </el-form>

                            <!-- 扫描结果 -->
                            <div v-if="scanResult" class="result-section">
                                <h3>扫描结果</h3>
                                <el-row :gutter="20">
                                    <el-col :span="8">
                                        <el-statistic title="Agents" :value="scanResult.scan_summary?.total_agents || 0" />
                                    </el-col>
                                    <el-col :span="8">
                                        <el-statistic title="Tools" :value="scanResult.scan_summary?.total_tools || 0" />
                                    </el-col>
                                    <el-col :span="8">
                                        <el-statistic title="Files" :value="scanResult.scan_summary?.total_files || 0" />
                                    </el-col>
                                </el-row>

                                <el-divider />

                                <!-- Agents列表 -->
                                <div v-if="scanResult.agents && scanResult.agents.length > 0">
                                    <h4>发现的Agents</h4>
                                    <el-table :data="scanResult.agents" style="width: 100%">
                                        <el-table-column prop="name" label="名称" width="150" />
                                        <el-table-column prop="arguments.role" label="角色" width="200" />
                                        <el-table-column prop="file" label="文件" show-overflow-tooltip />
                                        <el-table-column prop="line" label="行号" width="80" />
                                    </el-table>
                                </div>
                            </div>
                        </el-card>
                    </div>

                    <!-- 关系图构建 -->
                    <div v-show="activeTab === 'graph'" class="tab-content">
                        <el-card class="content-card">
                            <template #header>
                                <h2>🔗 关系图构建</h2>
                            </template>
                            
                            <el-form :model="graphForm" label-width="120px">
                                <el-form-item label="数据源">
                                    <el-radio-group v-model="graphForm.dataSource">
                                        <el-radio label="scan">使用扫描结果</el-radio>
                                        <el-radio label="path">直接扫描路径</el-radio>
                                    </el-radio-group>
                                </el-form-item>
                                
                                <el-form-item v-if="graphForm.dataSource === 'path'" label="扫描路径">
                                    <el-input v-model="graphForm.path" placeholder="请输入路径" />
                                </el-form-item>
                                
                                <el-form-item>
                                    <el-button 
                                        type="primary" 
                                        @click="buildGraph"
                                        :loading="graphLoading"
                                        :disabled="graphForm.dataSource === 'scan' && !scanResult">
                                        构建关系图
                                    </el-button>
                                    <el-button type="info" @click="loadDemoGraph">加载演示图</el-button>
                                </el-form-item>
                            </el-form>

                            <!-- 图可视化 -->
                            <div v-if="graphResult" class="graph-visualization">
                                <h3>关系图</h3>
                                <div id="graph-container" class="graph-container"></div>
                                
                                <!-- 图统计信息 -->
                                <el-row :gutter="20" class="graph-stats">
                                    <el-col :span="6">
                                        <el-statistic title="节点数" :value="graphResult.metadata?.total_nodes || 0" />
                                    </el-col>
                                    <el-col :span="6">
                                        <el-statistic title="边数" :value="graphResult.metadata?.total_edges || 0" />
                                    </el-col>
                                    <el-col :span="6">
                                        <el-statistic title="组件数" :value="graphResult.metadata?.components || 0" />
                                    </el-col>
                                    <el-col :span="6">
                                        <el-statistic title="密度" :value="graphResult.metadata?.density || 0" :precision="3" />
                                    </el-col>
                                </el-row>
                            </div>
                        </el-card>
                    </div>

                    <!-- 路径分析 -->
                    <div v-show="activeTab === 'paths'" class="tab-content">
                        <el-card class="content-card">
                            <template #header>
                                <h2>🛣️ 路径分析</h2>
                            </template>
                            
                            <el-form :model="pathsForm" label-width="120px">
                                <el-form-item label="数据源">
                                    <el-radio-group v-model="pathsForm.dataSource">
                                        <el-radio label="graph">使用图数据</el-radio>
                                        <el-radio label="file">图文件</el-radio>
                                    </el-radio-group>
                                </el-form-item>
                                
                                <el-form-item v-if="pathsForm.dataSource === 'file'" label="图文件">
                                    <el-input v-model="pathsForm.graphFile" placeholder="请输入图文件路径" />
                                </el-form-item>
                                
                                <el-form-item>
                                    <el-button 
                                        type="primary" 
                                        @click="analyzePaths"
                                        :loading="pathsLoading"
                                        :disabled="pathsForm.dataSource === 'graph' && !graphResult">
                                        分析路径
                                    </el-button>
                                </el-form-item>
                            </el-form>

                            <!-- 路径分析结果 -->
                            <div v-if="pathsResult" class="paths-result">
                                <h3>路径分析结果</h3>
                                
                                <!-- 路径统计 -->
                                <el-row :gutter="20">
                                    <el-col :span="8">
                                        <el-statistic 
                                            title="总路径数" 
                                            :value="pathsResult.analysis_summary?.total_paths || 0" />
                                    </el-col>
                                    <el-col :span="8">
                                        <el-statistic 
                                            title="关键路径" 
                                            :value="pathsResult.analysis_summary?.critical_paths || 0" />
                                    </el-col>
                                    <el-col :span="8">
                                        <el-statistic 
                                            title="平均长度" 
                                            :value="pathsResult.analysis_summary?.average_length || 0" 
                                            :precision="2" />
                                    </el-col>
                                </el-row>

                                <!-- 关键路径列表 -->
                                <div v-if="pathsResult.critical_paths">
                                    <h4>关键路径</h4>
                                    <el-collapse>
                                        <el-collapse-item 
                                            v-for="(path, index) in pathsResult.critical_paths.slice(0, 10)" 
                                            :key="index"
                                            :title="`路径 ${index + 1} - 长度: ${path.length}`">
                                            <el-tag 
                                                v-for="(node, nodeIndex) in path.path" 
                                                :key="nodeIndex"
                                                class="path-node"
                                                v-text="node">
                                            </el-tag>
                                        </el-collapse-item>
                                    </el-collapse>
                                </div>
                            </div>
                        </el-card>
                    </div>

                    <!-- 日志分析 -->
                    <div v-show="activeTab === 'logs'" class="tab-content">
                        <el-card class="content-card">
                            <template #header>
                                <h2>📊 日志分析</h2>
                            </template>
                            
                            <el-form :model="logsForm" label-width="120px">
                                <el-form-item label="日志文件">
                                    <el-input v-model="logsForm.logFile" placeholder="请输入日志文件路径" />
                                </el-form-item>
                                
                                <el-form-item label="日志格式">
                                    <el-select v-model="logsForm.format">
                                        <el-option label="自动检测" value="auto" />
                                        <el-option label="CSV格式" value="csv" />
                                        <el-option label="文本格式" value="txt" />
                                    </el-select>
                                </el-form-item>
                                
                                <el-form-item label="图文件">
                                    <el-input v-model="logsForm.graphFile" placeholder="可选：用于路径验证的图文件" />
                                </el-form-item>
                                
                                <el-form-item>
                                    <el-button 
                                        type="primary" 
                                        @click="analyzeLogs"
                                        :loading="logsLoading">
                                        分析日志
                                    </el-button>
                                </el-form-item>
                            </el-form>

                            <!-- 日志分析结果 -->
                            <div v-if="logsResult" class="logs-result">
                                <h3>日志分析结果</h3>
                                
                                <!-- 执行统计 -->
                                <el-row :gutter="20">
                                    <el-col :span="6">
                                        <el-statistic 
                                            title="总条目数" 
                                            :value="logsResult.log_summary?.total_entries || 0" />
                                    </el-col>
                                    <el-col :span="6">
                                        <el-statistic 
                                            title="执行路径" 
                                            :value="logsResult.execution_paths?.length || 0" />
                                    </el-col>
                                    <el-col :span="6">
                                        <el-statistic 
                                            title="异常数量" 
                                            :value="logsResult.anomalies?.length || 0" />
                                    </el-col>
                                    <el-col :span="6">
                                        <el-statistic 
                                            title="成功率" 
                                            :value="calculateSuccessRate(logsResult)" 
                                            suffix="%" />
                                    </el-col>
                                </el-row>

                                <!-- 异常列表 -->
                                <div v-if="logsResult.anomalies && logsResult.anomalies.length > 0">
                                    <h4>检测到的异常</h4>
                                    <el-alert 
                                        v-for="(anomaly, index) in logsResult.anomalies" 
                                        :key="index"
                                        :title="anomaly.type"
                                        :description="anomaly.description"
                                        type="warning"
                                        class="anomaly-alert" />
                                </div>

                                <!-- 建议 -->
                                <div v-if="logsResult.recommendations && logsResult.recommendations.length > 0">
                                    <h4>优化建议</h4>
                                    <ul class="recommendations-list">
                                        <li v-for="(rec, index) in logsResult.recommendations" :key="index"
                                            v-text="rec">
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </el-card>
                    </div>

                    <!-- 分析结果 -->
                    <div v-show="activeTab === 'results'" class="tab-content">
                        <el-card class="content-card">
                            <template #header>
                                <h2>📁 分析结果</h2>
                            </template>
                            
                            <el-button @click="loadResults" type="primary" class="refresh-btn">
                                刷新列表
                            </el-button>

                            <el-table :data="resultFiles" style="width: 100%">
                                <el-table-column prop="filename" label="文件名" show-overflow-tooltip />
                                <el-table-column prop="type" label="类型" width="100">
                                    <template #default="scope">
                                        <el-tag :type="getResultTypeColor(scope.row.type)"
                                                v-text="scope.row.type">
                                        </el-tag>
                                    </template>
                                </el-table-column>
                                <el-table-column prop="size" label="大小" width="100">
                                    <template #default="scope">
                                        <span v-text="formatFileSize(scope.row.size)"></span>
                                    </template>
                                </el-table-column>
                                <el-table-column prop="modified" label="修改时间" width="200">
                                    <template #default="scope">
                                        <span v-text="formatDate(scope.row.modified)"></span>
                                    </template>
                                </el-table-column>
                                <el-table-column label="操作" width="150">
                                    <template #default="scope">
                                        <el-button 
                                            size="small" 
                                            @click="viewResult(scope.row)">
                                            查看
                                        </el-button>
                                        <el-button 
                                            size="small" 
                                            type="danger" 
                                            @click="deleteResult(scope.row)">
                                            删除
                                        </el-button>
                                    </template>
                                </el-table-column>
                            </el-table>
                        </el-card>
                    </div>
                </el-main>
            </el-container>
        </el-container>

        <!-- 关于对话框 -->
        <el-dialog v-model="showAbout" title="关于 Watchdog" width="50%">
            <div class="about-content">
                <h3>🔍 Watchdog - Agent系统检测与分析工具</h3>
                <p>Watchdog是一个专门用于分析和检测Agent系统的综合工具，提供以下功能：</p>
                <ul>
                    <li>🔍 <strong>系统扫描</strong>：自动识别Agent、Tools、Crews等组件</li>
                    <li>🔗 <strong>关系图构建</strong>：构建系统组件间的关系图</li>
                    <li>🛣️ <strong>路径分析</strong>：分析执行路径和关键路径</li>
                    <li>📊 <strong>日志分析</strong>：深度分析执行日志，检测异常</li>
                </ul>
                <p>支持的框架：CrewAI、AutoGen、LangChain等主流Agent框架</p>
            </div>
        </el-dialog>

        <!-- 结果查看对话框 -->
        <el-dialog v-model="showResultDialog" :title="currentResult?.filename" width="80%">
            <pre class="result-content" v-text="JSON.stringify(currentResultData, null, 2)"></pre>
        </el-dialog>
    </div>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>
